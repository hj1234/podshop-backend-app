{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 600px;
        width: 100%;
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
    }
    /* Dark mode styling for Leaflet controls */
    .leaflet-control-zoom a {
        background-color: #1a1a1a !important;
        color: #d4af37 !important;
        border: 1px solid #333 !important;
    }
    .leaflet-control-zoom a:hover {
        background-color: #252525 !important;
        color: #f5d76e !important;
    }
    .leaflet-control-attribution {
        background-color: rgba(26, 26, 26, 0.8) !important;
        color: #888 !important;
    }
    .leaflet-control-attribution a {
        color: #d4af37 !important;
    }
    .leaflet-popup-content-wrapper {
        background: #1a1a1a !important;
        color: #e0e0e0 !important;
        border: 1px solid #333 !important;
    }
    .leaflet-popup-tip {
        background: #1a1a1a !important;
        border: 1px solid #333 !important;
    }
    .leaflet-container a.leaflet-popup-close-button {
        color: #888 !important;
    }
    .leaflet-container a.leaflet-popup-close-button:hover {
        color: #d4af37 !important;
    }
    .map-legend {
        background: #1a1a1a;
        padding: 1rem;
        border: 1px solid #333;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        gap: 2rem;
        align-items: center;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .legend-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #333;
    }
    .legend-marker.in-progress {
        background: #4caf50;
    }
    .legend-marker.historical {
        background: #ff9800;
    }
    .map-stats {
        color: #888;
        font-size: 0.875rem;
    }
    /* Style for Leaflet popup scrollbar */
    .leaflet-popup-content {
        max-height: 400px;
        overflow-y: auto;
    }
    .leaflet-popup-content::-webkit-scrollbar {
        width: 8px;
    }
    .leaflet-popup-content::-webkit-scrollbar-track {
        background: #1a1a1a;
        border-radius: 4px;
    }
    .leaflet-popup-content::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 4px;
    }
    .leaflet-popup-content::-webkit-scrollbar-thumb:hover {
        background: #777;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Games Map View</h2>
    <div class="map-stats">
        Total markers: {{ markers|length }}
    </div>
</div>

<div class="map-legend">
    <div class="legend-item">
        <div class="legend-marker in-progress"></div>
        <span style="color: #e0e0e0;">In Progress</span>
    </div>
    <div class="legend-item">
        <div class="legend-marker historical"></div>
        <span style="color: #e0e0e0;">Historical</span>
    </div>
</div>

<div id="map"></div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Initialize map with scroll wheel zoom disabled
    const map = L.map('map', {
        scrollWheelZoom: false,
        doubleClickZoom: false
    }).setView([51.5, -0.1], 2); // Default to London, zoom level 2
    
    // Add dark tile layer (CartoDB Dark Matter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);
    
    // Game markers data from template
    const markers = {{ markers|tojson }};
    
    // Group markers by location to handle clustering
    const locationGroups = {};
    markers.forEach(marker => {
        const key = `${marker.lat.toFixed(4)},${marker.lng.toFixed(4)}`;
        if (!locationGroups[key]) {
            locationGroups[key] = [];
        }
        locationGroups[key].push(marker);
    });
    
    // Create markers
    Object.values(locationGroups).forEach(group => {
        const firstMarker = group[0];
        const isMultiple = group.length > 1;
        
        // Choose color based on type (prioritize in-progress if mixed)
        const hasInProgress = group.some(m => m.type === 'in_progress');
        const color = hasInProgress ? '#4caf50' : '#ff9800';
        const typeLabel = hasInProgress ? 'In Progress' : 'Historical';
        
        // Create custom icon
        const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="
                width: 20px;
                height: 20px;
                background: ${color};
                border: 2px solid #fff;
                border-radius: 50%;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            "></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        // Build popup content
        const popupWrapperStyle = isMultiple 
            ? 'min-width: 200px; max-width: 300px; max-height: 400px; overflow-y: auto; color: #e0e0e0;'
            : 'min-width: 200px; color: #e0e0e0;';
        
        let popupContent = `<div style="${popupWrapperStyle}">`;
        if (isMultiple) {
            popupContent += `<strong style="color: #d4af37;">${group.length} games at this location</strong><br><br>`;
        }
        
        group.forEach((marker, idx) => {
            if (isMultiple && idx > 0) popupContent += '<hr style="border-color: #333; margin: 0.5rem 0;">';
            
            popupContent += `<strong>${marker.fund_name}</strong><br>`;
            popupContent += `<small style="color: #888;">Type: ${marker.type === 'in_progress' ? 'In Progress' : 'Historical'}</small><br>`;
            popupContent += `<small style="color: #888;">Started: ${marker.time_started || 'N/A'}</small><br>`;
            
            if (marker.time_ended) {
                popupContent += `<small style="color: #888;">Ended: ${marker.time_ended}</small><br>`;
            }
            
            if (marker.total_pnl !== null && marker.total_pnl !== undefined) {
                const pnlColor = marker.total_pnl >= 0 ? '#4caf50' : '#f44336';
                popupContent += `<small style="color: ${pnlColor};">PnL: $${marker.total_pnl.toLocaleString()}</small><br>`;
            }
            
            popupContent += `<small style="color: #888; font-size: 0.7rem;">ID: <code style="font-size: 0.7rem;">${marker.id}</code></small>`;
            
            if (idx < group.length - 1) popupContent += '<br>';
        });
        
        popupContent += '</div>';
        
        // Create marker
        const leafletMarker = L.marker([firstMarker.lat, firstMarker.lng], { icon: icon })
            .addTo(map)
            .bindPopup(popupContent);
    });
    
    // Fit map to show all markers if we have any
    if (markers.length > 0) {
        const bounds = markers.map(m => [m.lat, m.lng]);
        map.fitBounds(bounds, { padding: [50, 50] });
    }
</script>
{% endblock %}

